<script>
    $(document).ready(function(){
        getRollbaseObjects();
    });

    function attachRbObjectsEvent(){
        $("#select-rb-objects").on("change", function(){
            var selectedObj = String($(this).val());
            if(selectedObj) getObjectFields(selectedObj);
        });
    }
    
    /* Retrieves the Rollbase Objects */
    function getRollbaseObjects(){
        r_login(g_un, g_pw, function(session){ // Initiate first login to generate first session
            if(session){
                r_getObjectDefNames(session, function(data){
                    if(data){
                        var RB_Objects = "";
                        $.each(data, function(index,value) {
                            RB_Objects += "<option value='"+value+"'>"+value+"</option>";
                        });
                        // console.log("RB_Objects = "+RB_Objects);
                        $("#select-rb-objects").append(RB_Objects);
                        attachRbObjectsEvent();
                    }
                });
            }else{ console.log("Invalid Session Id"); }
        });   
    }

    /* Retrieves the Fields under the selected RB object */
    function getObjectFields(obj){
        r_login(g_un, g_pw, function(session){ // Initiate first login to generate first session
            if(session){
                r_getObjectDef(session, obj, function(data){
                    if(data){
                        $("#select-rb-fields").html("");    //clear the field before appending new options
                        var objName = $(data).find("SingularName").text();
                        var objFields = $(data).find("DataFieldDef");
        
                        var isReadOnly, currField;
                        var RB_fields = "<option value=''>Please Select...</option>";
                        $(objFields).each(function(){
                            isReadOnly = String(this.getAttribute("isReadOnly")) == "true";
                            
                            if(!isReadOnly){
                                currField = this.getAttribute("fieldName");
                                RB_fields += "<option value='"+currField+"'>"+currField+"</option>";
                            }
                        });
                        
                        console.log("RB_fields = "+RB_fields);
                        $("#select-rb-fields").append(RB_fields);
                    }
                });
            }
        });
    }

    /* Re-usable Rest Functions */
    var g_un = 'dev1', g_pw = 'rollbase123';
    var baseURL = "http://dev.ppm.cloud/rest/api/";
    function r_login(un, pw, cb){
        $.ajax({
            url         :   baseURL+"login?loginName="+un+"&password="+pw+"&output=JSON",
            contentType :   false,
            processData :   false,
            cache       :   false,
            success: function(resp) {
                var data = Object(resp);
                cb(data.sessionId);
            }, 
            error: function(resp) {
                var data = Object(resp);
                console.log("Error in r_login: " + String(data.responseText));
            }
        });
    } //(end)r_login

    function r_getObjectDefNames(session, cb){
        $.ajax({
            method      : "GET",
            url         :   baseURL+"getObjectDefNames?sessionId="+session+"&output=JSON",
            cache       :   false,
            success: function(resp) {
                var data = Object(resp);
                cb(data);
            }, 
            error: function(resp) {
                var data = Object(resp);
                console.log("Error in r_getObjectDefNames: " + String(data.responseText));
            }
        });
    } //(end)r_getObjectDefNames

    function r_getObjectDef(session, obj, cb){
        $.ajax({
            method      : "GET",
            url         :   baseURL+"getObjectDef?sessionId="+session+"&objName="+obj,
            cache       :   false,
            success: function(resp) {
                var data = Object(resp);
                cb(data);
            }, 
            error: function(resp) {
                var data = Object(resp);
                console.log("Error in r_getObjectDef: " + String(data.responseText));
            }
        });
    } //(end)r_getObjectDefNames
</script>