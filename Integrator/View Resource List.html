<div id="div-buttons">
    <input type="button" id="btn-cu" class="btn btn-success custom-btn" value="Save Changes" onclick="createOrUpdateRecords()"/>

    <div class="row">
        <div class="col-lg-4">
            <div class="input-group">
                <input type="text" id="no-of-rows" class="form-control" placeholder="No. of rows...">
                <span class="input-group-btn">
                <button class="btn btn-default" type="button" onclick="addRows()">Add Rows</button>
                </span>
            </div><!-- /input-group -->
        </div><!-- /.col-lg-4 -->
    </div>

</div>

<!-- Spread.Sheets widget container -->
<div id="spreadContainer"></div>

<script type="text/javascript">
    var lc = "124285779463225#A0jZcJCL3V6csFmZ0IiczRmI1pjIs9WQisnOiQkIsISP3EVah3CNr3iaklXNGRmZnJXOzN6UNNna0JlclNnU7FTRPNTeXNWV9s4VMNnNVZmMyk4dEhEVIFmMmlkekFGOHx4doF6RBRmQNhjVtdjYjh4bQdnW7Z7YiojITJCL6MjM7IjMzQzN0IicfJye35XX3JyMiZzZiojIDJCLiETMuYHITpEIkFWZyB7UiojIOJyebpjIkJHUiwiI8IzN4ATMgIjM9ADOxAjMiojI4J7QiwiIxIjMxgTMwIjI0ICc8VkIsICZ4xEIpkHdQhCIzVWan3Gbv9GajVGVgUncl5kI0ISYONkIsISNyIzM6QTO7cTN8IDNyE7IJI";

    GC.Spread.Sheets.LicenseKey = lc;   //Spread.Sheets License Key
    var spread;                         //instantiate spreadsheet variable

    $(function(){
        retrieveRecords();
    });

    function retrieveRecords(){
        spread = new GC.Spread.Sheets.Workbook(document.getElementById("spreadContainer"));
        var qry = "SELECT id, Code, Resource_Name, Resource_Type#value, Start_Date_Active, End_Date_Active FROM Resource";
        rbf_selectQuery(qry, 999, function(data){
            convert2dArrToJSON(data);

            var sheet = spread.getActiveSheet();
            sheet.getCell(-1, 0).width(50);
            sheet.getCell(-1, 1).width(170);
            sheet.getCell(-1, 2).width(170);
            sheet.getCell(-1, 3).width(170);
            sheet.getCell(-1, 4).width(170);
            sheet.getCell(-1, 5).width(170);
        });
    }

    function convert2dArrToJSON(arr){
        var resultArr = [];
        for(var i=0, len=arr.length; i < len; i++){
            var jsonObj = {};
                jsonObj["ID"] = arr[i][0];
                jsonObj["Code"] = arr[i][1];
                jsonObj["Resource_Name"] = arr[i][2];
                jsonObj["Resource_Type"] = arr[i][3];
                jsonObj["Start_Date_Active"] = setValidDate(arr[i][4]);
                jsonObj["End_Date_Active"] = setValidDate(arr[i][5]);
            
            resultArr.push(jsonObj);
        }

        populateRecords(resultArr);
    }

    function populateRecords(tableData){
        spread.getActiveSheet().setDataSource(tableData);

        var dropdownValues = ["Equipment","Financial","Material","People"];
        var cellType2 = new GC.Spread.Sheets.CellTypes.ComboBox(); 
        var activeSheet = spread.getActiveSheet();
        cellType2.items(dropdownValues);
        activeSheet.getCell(-1, 3).cellType(cellType2);
    }

    var successfulUpdate = 0, successfulCreate = 0, totalRows = 0;
    function createOrUpdateRecords(){
        var sheet = spread.getActiveSheet();
        totalRows = sheet.getRowCount();

        var resourceList = parseInt("{!id}");  //Resource List
        for(var i=0; i < totalRows; i++){
            var objName = "Resource";
            var recordId = parseInt(sheet.getValue(i, 0));
            var fieldMap = {
                    "Resource_List"     : resourceList,
                    "Code"              : sheet.getValue(i, 1),
                    "Resource_Name"     : sheet.getValue(i, 2),
                    "Resource_Type"     : sheet.getValue(i, 3),
                    "Start_Date_Active" : setValidDate(sheet.getValue(i, 4)),
                    "End_Date_Active"   : setValidDate(sheet.getValue(i, 5))
                }
            if(recordId > 0){
                rbf_updateRecord(objName, recordId, fieldMap, false, function(data){
                    incrementCounter("update");
                }, false);
            }else{
                rbf_createRecord(objName, fieldMap, false, function(data){
                    incrementCounter("create");
                }, false);
            }
        }
       
    }

    /* Check created/updated records then reload the page */
    function incrementCounter(ctr){
        if("update") successfulUpdate++; else successfulCreate++;
        
        if((successfulUpdate + successfulCreate) == totalRows){
            var message = "Successfully updated/created Resource records.";
            // if(successfulUpdate == 0 ) message = "Successfully created "+successfulCreate+" records.";
            // if(successfulCreate == 0 ) message = "Successfully updated "+successfulUpdate+" records.";

            swal(message, "The page will now reload to reflect the changes.", "success").then((value) => {
                window.location.reload();
            });
        }
    }

    /* Converts the date to MM/dd/yyyy format */
    function setValidDate(dateVal){
        if(dateVal){
            dateVal = new Date(String(dateVal));
            var result = rbf_formatDate(dateVal, "MM/dd/yyyy");
            return result;
        }
        return "";
    }

    /* Adds additional rows at the bottom of the sheet */
    function addRows(){
        var noOfRows = parseInt($("#no-of-rows").val());
        if(noOfRows > 0){
            var sheet = spread.getActiveSheet();
                sheet.addRows(-1,noOfRows);  
        }else{
            swal("Error", "Please enter a value for the no. of Rows", "error");
        }
        
    }

</script>