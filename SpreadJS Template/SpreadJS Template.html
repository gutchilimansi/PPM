<!-- VIEW SPREADJS TEMPLATE -->

<div id="div-buttons">
    <input type="button" id="btn-lo" class="btn btn-primary custom-btn" value="Load Template & Records" onclick="loadOriginalTemplate()"/>
    <input type="button" id="btn-cu" class="btn btn-success custom-btn default-hidden" value="Save Changes" onclick="createOrUpdateRecords()"/>

    <div class="row default-hidden">
        <div class="col-lg-4">
            <div class="input-group">
                <input type="text" id="no-of-rows" class="form-control" placeholder="No. of rows...">
                <span class="input-group-btn">
                <button class="btn btn-default" type="button" onclick="addRows()">Add Rows</button>
                </span>
            </div><!-- /input-group -->
        </div><!-- /.col-lg-4 -->
    </div>
</div>

<!-- Spread.Sheets widget container -->
<div id="spreadContainer"></div>

<script type="text/javascript">
    var lc = "124285779463225#A0jZcJCL3V6csFmZ0IiczRmI1pjIs9WQisnOiQkIsISP3EVah3CNr3iaklXNGRmZnJXOzN6UNNna0JlclNnU7FTRPNTeXNWV9s4VMNnNVZmMyk4dEhEVIFmMmlkekFGOHx4doF6RBRmQNhjVtdjYjh4bQdnW7Z7YiojITJCL6MjM7IjMzQzN0IicfJye35XX3JyMiZzZiojIDJCLiETMuYHITpEIkFWZyB7UiojIOJyebpjIkJHUiwiI8IzN4ATMgIjM9ADOxAjMiojI4J7QiwiIxIjMxgTMwIjI0ICc8VkIsICZ4xEIpkHdQhCIzVWan3Gbv9GajVGVgUncl5kI0ISYONkIsISNyIzM6QTO7cTN8IDNyE7IJI";

    GC.Spread.Sheets.LicenseKey = lc;   //Spread.Sheets License Key

    $(function(){
        // loadOriginalTemplate();
    });

    /* Loads the saved JSON file in the current template */
    function loadOriginalTemplate(){
        $("#btn-lo").attr("disabled","disabled");

        spreadjs_getSpread();
        
        $.ajax({
            url: "{!R30977.Template_File#url}",         //chosen template
            datatype: "json",
            success: function (data) {

                var jsonStr = JSON.stringify(Object(data));
                spread.fromJSON(JSON.parse(jsonStr));
                
                $("#spreadContainer").show();
                $(".default-hidden").show();
                convertTemplateForUsers();
            },
            error: function (e) {
                swal("Error loading spreadsheet", e, "error");
            }
        });
    }

    /* Converts the chosen template to a template where users can enter data that will be saved into RB */
    var columnHeaders = [], noOfRecords = 0,
        sourceObject = "{!Object_Integration_Name}";  //get the source object where the records will come from
    var filterSheet = "", qryFilters ="";
    function convertTemplateForUsers(){
        
        //Loop through each Sheet
        var currentSheets = spread.getSheetCount(), currSheetName="";
        for(var i=0, len=currentSheets; i < len; i++){
            currSheetName = spread.sheets[i].name();
            if(currSheetName == "Filters"){
                filterSheet = spread.sheets[i];

                // Build the filters that will be used in querying the records
                var rowCount = filterSheet.getRowCount(),
                    currCellField="",currCellValue="", curCellColumn="", currCellType="";
                for(var j=0; j < rowCount; j++){
                    currCellField   = filterSheet.getCell(j,0).text();
                    currCellValue   = filterSheet.getCell(j,1).text();
                    
                    if(!currCellField) break; //end loop already if there are no more succeeding records

                    curCellColumn   = currCellField.split(".")[1];
                    currCellType    = currCellField.split(".")[2];

                    if(currCellType == "LU"){
                        qryFilters += curCellColumn+ " = " + currCellValue.split("|")[0];
                    }else{
                        qryFilters += curCellColumn+ " = " + currCellValue;
                    }
                }

            }else if(currSheetName.indexOf("Records") >= -1){
                var currRecordsSheet = spread.sheets[i],
                    currColumnHeaders = [];

                //loop through each cell's column header until reaching a blank column
                var ctr = 0, currentCellVal = String(currRecordsSheet.getCell(0,ctr).text());
                while(currentCellVal){
                    if(currentCellVal){
                        currColumnHeaders.push(currentCellVal);
                    }
                    ctr++;
                    currentCellVal = String(currRecordsSheet.getCell(0,ctr).text())
                }

                // Set Column Headers
                if(currColumnHeaders.length > 0){
                    retrieveColumns(currRecordsSheet, currColumnHeaders);    
                }
            }
        }
    }

    function retrieveColumns(recordsSheet, columnHeaders){
        var qry = "SELECT COUNT(id) FROM "+sourceObject;
        if(qryFilters) qry += " WHERE " +qryFilters;
        rbf_selectNumber(qry, function(data){
            if(parseInt(data) > 0){
                noOfRecords = parseInt(data);
                retrieveRecords(recordsSheet, columnHeaders, noOfRecords);                  //There are records related to the Source Object
            }else{
                presetColumnHeaders(currRecordsSheet, columnHeaders, noOfRecords);              //There are NO records related to the Source Object
            }
        });
    }

    /* Set the default column headers for without Records yet */
    function presetColumnHeaders(currRecordsSheet, currColumnHeaders, noOfRecords){
        var resultArr = [], jsonObj = {};
        for(var j=0, len2=currColumnHeaders.length; j < len2; j++){
                var currColumn  = currColumnHeaders[j].split(".")[1];
                jsonObj[currColumn] = "";
            }
        
        resultArr.push(jsonObj);
        if(resultArr) populateRecords(resultArr, currRecordsSheet, currColumnHeaders, noOfRecords);  //Add column headers only without any records
    }

    /* To-do:
        - several objects query
        - searchable dropdowns
        - deleting of records
        - single value lookup
    */

    /* Retrieves records from the applicable Rollbase table */
    function retrieveRecords(currRecordsSheet, columnHeaders, noOfRecords){
        var currVal         = "", currType = "",
            qry             = "SELECT id";

        for(var i=0, len=columnHeaders.length; i < len; i++){
            currVal = columnHeaders[i].split(".")[1];
            
            //retrieve the actual #values for picklist and lookup fields:
            currType = columnHeaders[i].split(".")[2];
            if(currType == "PL") currVal += "#value"; 
            qry += ", "+ currVal;
        }
        qry += " FROM " + sourceObject;
        if(qryFilters) qry += " WHERE " +qryFilters;

        columnHeaders.unshift("id");    //add record 'id' at index 1

        rbf_selectQuery(qry, 999, function(data){
            convert2dArrColumnsToJSON(data, currRecordsSheet, columnHeaders, noOfRecords);
        });
    }

    /* Converts the given 2d array columns result set to a JSON object */
    function convert2dArrColumnsToJSON(arr, currRecordsSheet, currColumnHeaders, noOfRecords){
        var resultArr = [];
        for(var i=0, len=arr.length; i < len; i++){
            var jsonObj = {};
            for(var j=0, len2=currColumnHeaders.length; j < len2; j++){
                var currColumn  = (j > 0) ? currColumnHeaders[j].split(".")[1] : currColumnHeaders[j],
                    currType    = currColumnHeaders[j].split(".")[2];
                    
                if(currType == "DT"){
                    jsonObj[currColumn] = formatDate(arr[i][j]);  
                }else{
                    jsonObj[currColumn] = arr[i][j];
                }
            }
            resultArr.push(jsonObj);
        }
        
        populateRecords(resultArr, currRecordsSheet, currColumnHeaders, noOfRecords);
    }
    
    /* Adds the records in the spreadjs sheet depending on the JSON data set */
    function populateRecords(tableData, currRecordsSheet, currColumnHeaders, noOfRecords){

        currRecordsSheet.setDataSource(tableData);

        setPicklistOrLookup(currRecordsSheet, currColumnHeaders);
        resizeColumns(currRecordsSheet, currColumnHeaders);

        if(noOfRecords > 0){
            addNewRow(true, currRecordsSheet);//add 1 new default row
            swal("Finished loading "+noOfRecords+" records using the chosen template", "You may see the records in the 'Records' sheet(s)", "success").then((value) => {
                detectChangedSheets();
            });
        }else{
            swal("There are no records under the selected object","You may now add new records","info");
        }
    }

    function setPicklistOrLookup(currRecordsSheet, currColumnHeaders){
        for(var i=1, len=currColumnHeaders.length; i < len; i++){
            var currColumn  = currColumnHeaders[i],
                currType    = currColumn.split(".")[2];
            if(currType == "PL"){
                convertToPicklist(i,currColumn,currRecordsSheet);
            }else if(currType == "LU"){
                convertToLookup(i,currColumn,currRecordsSheet);
            }
        }
    }

    /* Converts a column's cells to Picklist fields */
    function convertToPicklist(currIndex, currColumn,currRecordsSheet){
        var qry = "SELECT Picklist_Values FROM Template_Object_Field WHERE Field_Code = '"+currColumn+"'";
        rbf_selectValue(qry, function(data){
            if(data){
                var cellType = new GC.Spread.Sheets.CellTypes.ComboBox(); 
                    cellType.items( data.split("|") );

                currRecordsSheet.getCell(-1, currIndex).cellType(cellType);
            }
        });
    }

    /* Converts a column's cells to Lookup fields */
    function convertToLookup(currIndex, currColumn,currRecordsSheet){
        var qry = "SELECT Lookup_Table FROM Template_Object_Field WHERE Field_Code = '"+currColumn+"'";
        rbf_selectValue(qry, function(data){
            if(data){
                qry = "SELECT id, name FROM "+data;
                rbf_selectQuery(qry, 999, function(data2){
                    if(data2){
                        var lookupValuesArr = [], lookupValuesJson = {};
                        for(var i=0, len=data2.length; i < len; i++){
                            currId      = data2[i][0],
                            currName    = data2[i][1];
                            lookupValuesArr.push(currId+"|"+currName);
                            lookupValuesJson[currId] = currId+"|"+currName;
                        }
                        var cellType = new GC.Spread.Sheets.CellTypes.ComboBox(); 
                            cellType.items( lookupValuesArr );

                        currRecordsSheet.getCell(-1, currIndex).cellType(cellType);

                        changeLookupIDToValues(currIndex, lookupValuesJson);
                    }
                });
            }
        });
    }
   
    function changeLookupIDToValues(currIndex, lookupValuesJson, currRecordsSheet){

        var currCell    = "",
            rowCount    = currRecordsSheet.getRowCount();
        for(var i=0; i < rowCount; i++){
            currCell = currRecordsSheet.getCell(i,currIndex);
            currCell.text( lookupValuesJson[currCell.text()] );
        }
    }

    /* Resizes the columns to fix widths */
    function resizeColumns(currRecordsSheet, currColumnHeaders){
        for(var i=0; i < currColumnHeaders.length; i++){
            currRecordsSheet.getCell(-1, i).width(140);  //set cell width
        }
    }

    /* Detects if there is a changed cell in a row then changes the background color */
    function detectChangedSheets(){
        var currentSheets = spread.getSheetCount(), currSheetName="";
        for(var i=0, len=currentSheets; i < len; i++){
            currSheetName = spread.sheets[i].name();
            console.log("currSheetName = "+currSheetName);
            if(currSheetName.indexOf("Records") >= -1){
                var currRecordsSheet = spread.sheets[i];
                        
                    
                    spreadjs_getActiveSheet();
                        
                    currRecordsSheet.bind(GC.Spread.Sheets.Events.CellChanged, function (e, info) {
                    if(info.sheetArea === GC.Spread.Sheets.SheetArea.viewport){
                        console.log("currRecordsSheet updated: "+currRecordsSheet.name());
                        console.log("Row number " +info.row+ " has been updated.");
                        var instance = new GC.Spread.Sheets.CellRange(currRecordsSheet, info.row, -1, 1, -1, GC.Spread.Sheets.SheetArea.viewport);
                        instance.backColor(updatedCellColor);

                        var editRecord = parseInt(currRecordsSheet.getCell(info.row, 0));
                        if( !(editRecord > 0) ) addNewRow(false, currRecordsSheet);    //automatically add rows once user is at the last row
                    }
                });
            }
        }
    }
    
    /* Adds a new row at the bottom */
    function addNewRow(isFirstLoad, currRecordsSheet){
        var rowCount = currRecordsSheet.getRowCount();

        var cellColorNew = currRecordsSheet.getCell(parseInt(rowCount) - 1, 0).backColor();
        
        if(cellColorNew == updatedCellColor || isFirstLoad) currRecordsSheet.addRows(rowCount, 1); //Add 1 row after the last row
    }

    /* Creates / Updates records based on the Spreadsheet */
    var successfulUpdate = 0, successfulCreate = 0, totalRows = 0;
    function createOrUpdateRecords(){
        $("#btn-cu").attr("disabled","disabled");

        var currentSheets = spread.getSheetCount(), currSheetName="";
        for(var i=0, len=currentSheets; i < len; i++){
            currSheetName = spread.sheets[i].name();
            if(currSheetName.indexOf("Records") >= -1){
                var currRecordsSheet = spread.sheets[i];
                    totalRows = currRecordsSheet.getRowCount();

                var totalRows = (totalRows > 1) ? totalRows -1 : totalRows;
                for(var i=0; i < totalRows; i++){
                    
                    var instance = new GC.Spread.Sheets.CellRange(currRecordsSheet, i, -1, 1, -1, GC.Spread.Sheets.SheetArea.viewport);
                    if(String(instance.backColor()) == updatedCellColor){ //detect if there was an update made //|| !(recordId > 0)
                        var recordId = parseInt(currRecordsSheet.getValue(i, 0)); //(noOfRecords == 0) ? 0 : 

                        var fieldMap = {};
                        var startingIndex = (noOfRecords == 0) ? 0 : 1;
                        for(var j=startingIndex, len=currRecordsSheet.length; j < len; j++){
                            var currField   = currRecordsSheet[j].split(".")[1],
                                currType    = currRecordsSheet[j].split(".")[2];
                                
                            if(currType == "DT"){   //date field handling
                                fieldMap[currField] = formatDate(currRecordsSheet.getValue(i,j));
                            }else{                  //all other data types
                                fieldMap[currField] = (currRecordsSheet.getValue(i,j))? currRecordsSheet.getValue(i,j) : "";
                            }
                        }  
                    
                        if(recordId > 0){
                            // alert("fieldMap = "+fieldMap);
                            // alert(JSON.stringify(fieldMap));
                            rbf_updateRecord(sourceObject, recordId, fieldMap, false, function(data){
                                incrementCounter("update");
                            }, false);
                        }else{
                            rbf_createRecord(sourceObject, fieldMap, false, function(data){
                                incrementCounter("create");
                            }, false);
                        }
                    }else{
                        // swal("There are no updates made yet.","Please create a new record or modify an existing one.","info");
                        $("#btn-cu").removeAttr("disabled");
                    }
                }
            }
        }
        $("#spreadContainer").show();
    }

    /* Check created/updated records then reload the page */
    function incrementCounter(ctrToIncrement){
        if(ctrToIncrement == "update") successfulUpdate++; else successfulCreate++;
        
        var message = "";
        if(successfulUpdate > 0 && successfulCreate == 0) message = "Successfully updated "+successfulUpdate+" record(s).";
        else if(successfulCreate > 0 && successfulUpdate == 0) message = "Successfully created "+successfulCreate+" record(s).";
        else message = "Successfully updated "+successfulUpdate+" & created "+successfulCreate+" record(s).";

        swal(message, "The page will now reload to reflect the changes.", "success").then((value) => {
            window.location.reload();
        });
    }
</script>